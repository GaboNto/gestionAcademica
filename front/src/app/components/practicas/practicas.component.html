<div class="Container Section">
  <!-- HEADER -->
  <div class="Header">
    <div class="Headline">
      <h1>Asignación de Prácticas</h1>
      <p class="Muted">Gestión de asignaciones de practicas para los estudiantes</p>
    </div>

    <div class="Spacer"></div>

    <!-- BOTÓN NUEVA ASIGNACIÓN -->
    <button mat-flat-button color="primary" (click)="abrirNuevaAsignacion()" class="BtnAdd">
      <mat-icon>person_add</mat-icon>
      Nueva Asignación
    </button>
  </div>

  <!-- FILTROS DE BÚSQUEDA -->
  <mat-card class="FiltersCard Elev">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>search</mat-icon>
        Filtros de Búsqueda
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="FiltersGrid">
        <mat-form-field appearance="outline" class="SearchField">
          <mat-label>Buscar</mat-label>
          <input matInput [(ngModel)]="terminoBusqueda" (ngModelChange)="onFiltersChange()" placeholder="Nombre, RUT o colegio..." />
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
        
        <!-- Nuevo filtro: Nivel (Plan) -->
        <mat-form-field appearance="outline" class="FilterField">
          <mat-label>Nivel</mat-label>
          <mat-select [(ngModel)]="nivelSeleccionado" (ngModelChange)="onFiltersChange()">
            <mat-option value="all">Todos los niveles</mat-option>
            @for (n of niveles; track n) {
              <mat-option [value]="n">{{ n }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="FilterField">
          <mat-label>Tipo de Centro Educativo</mat-label>
          <mat-select [(ngModel)]="colegioSeleccionado" (ngModelChange)="onFiltersChange()">
            <mat-select-trigger>
              {{ colegioSeleccionado === 'all' ? 'Todos los tipos' : (colegioSeleccionado | lowercase) }}
            </mat-select-trigger>
            <mat-option value="all">Todos los tipos</mat-option>
            @for (t of tiposCentro; track t) {
              <mat-option [value]="t">{{ t | lowercase }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- FORMULARIO (colapsable por botón) -->
  <div class="FormContainer" [class.FormOpen]="mostrarFormulario">
    @if (mostrarFormulario) {
      <mat-card class="Elev FormCard">
        <mat-card-header class="FormHeader">
          <div class="FormTitleSection">
            <div class="FormIcon">
              <mat-icon>person_add</mat-icon>
            </div>
            <div class="FormTitles">
              <h2>Asignar Nueva Práctica</h2>
              <p>Completa los datos para asignar una práctica a un estudiante</p>
            </div>
          </div>
          <button mat-icon-button (click)="cerrarFormulario()" class="CloseFormBtn">
            <mat-icon>close</mat-icon>
          </button>
        </mat-card-header>

        <mat-card-content class="FormContent">
          <form [formGroup]="formularioPractica" class="FormGrid">
            
            <!-- Información del Estudiante -->
            <div class="FormRow">
              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Estudiante *</mat-label>
                <input matInput 
                       placeholder="Escriba nombre o RUT del estudiante..."
                       (input)="filtrarEstudiantes($event)"
                       (focus)="mostrarTodosEstudiantes()
                       "
                       [matAutocomplete]="autoEstudiante"
                       formControlName="estudianteRut">
                <mat-autocomplete #autoEstudiante="matAutocomplete" 
                                  [displayWith]="mostrarEstudiante.bind(this)"
                                  (optionSelected)="onEstudianteSeleccionado($event)">
                  @for (estudiante of estudianteFiltrado; track estudiante.rut) {
                    <mat-option [value]="estudiante">
                      {{ estudiante.nombre }} - {{ estudiante.rut }}
                    </mat-option>
                  }
                </mat-autocomplete>
                @if (formularioPractica.get('estudianteRut')?.hasError('required')) {
                  <mat-error>
                    Debe seleccionar un estudiante
                  </mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Centro Educativo *</mat-label>
                <input matInput 
                       placeholder="Escriba nombre, comuna o región del centro..."
                       (input)="filtrarCentros($event)"
                       (focus)="mostrarTodosCentros()"
                       [matAutocomplete]="autoCentro"
                       formControlName="centroId">
                <mat-autocomplete #autoCentro="matAutocomplete" 
                                  [displayWith]="mostrarCentro.bind(this)"
                                  (optionSelected)="onCentroSeleccionado($event)">
                  @for (centro of centroFiltrado; track centro.id) {
                    <mat-option [value]="centro">
                      {{ centro.nombre }} - {{ centro.comuna }}, {{ centro.region }}
                    </mat-option>
                  }
                </mat-autocomplete>
                @if (formularioPractica.get('centroId')?.hasError('required')) {
                  <mat-error>
                    Debe seleccionar un centro educativo
                  </mat-error>
                }
              </mat-form-field>
            </div>

            <!-- Colaboradores -->
            <div class="FormRow">
              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Colaborador 1 *</mat-label>
                <mat-select formControlName="colaborador1Id">
                  <mat-option [value]="null">Seleccionar colaborador...</mat-option>
                  @for (colaborador of colaboradores; track colaborador.id) {
                    <mat-option
                      [value]="colaborador.id"
                      [disabled]="isColaboradorSeleccionado(colaborador.id, 'colaborador1Id')">
                      {{ colaborador.nombre }}{{ colaborador.cargo ? ' (' + colaborador.cargo + ')' : '' }}
                    </mat-option>
                  }
                </mat-select>
                @if (formularioPractica.get('colaborador1Id')?.hasError('required')) {
                  <mat-error>Debes seleccionar al menos un colaborador</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Colaborador 2 (opcional)</mat-label>
                <mat-select formControlName="colaborador2Id">
                  <mat-option [value]="null">Sin asignar</mat-option>
                  @for (colaborador of colaboradores; track colaborador.id) {
                    <mat-option
                      [value]="colaborador.id"
                      [disabled]="isColaboradorSeleccionado(colaborador.id, 'colaborador2Id')">
                      {{ colaborador.nombre }}{{ colaborador.cargo ? ' (' + colaborador.cargo + ')' : '' }}
                    </mat-option>
                  }
                </mat-select>
                <mat-hint align="start">Puedes registrar hasta 2 colaboradores.</mat-hint>
              </mat-form-field>
            </div>

            <!-- Tutores -->
            <div class="FormRow">
              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Tutor 1 *</mat-label>
                <mat-select formControlName="tutor1Id">
                  <mat-option [value]="null">Seleccionar tutor...</mat-option>
                  @for (tutor of tutores; track tutor.id) {
                    <mat-option
                      [value]="tutor.id"
                      [disabled]="isTutorSeleccionado(tutor.id, 'tutor1Id')">
                      {{ tutor.nombre }}
                    </mat-option>
                  }
                </mat-select>
                @if (formularioPractica.get('tutor1Id')?.hasError('required')) {
                  <mat-error>Debes seleccionar al menos un tutor</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Rol Tutor 1 *</mat-label>
                <mat-select formControlName="tutor1Rol">
                  <mat-option [value]="''" disabled>Seleccionar rol</mat-option>
                  @for (rol of rolesTutor; track rol) {
                    <mat-option [value]="rol">{{ rol }}</mat-option>
                  }
                </mat-select>
                @if (formularioPractica.get('tutor1Rol')?.hasError('required')) {
                  <mat-error>Debes indicar un rol para el tutor</mat-error>
                }
              </mat-form-field>
            </div>

            <div class="FormRow">
              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Tutor 2 (opcional)</mat-label>
                <mat-select formControlName="tutor2Id">
                  <mat-option [value]="null">Sin asignar</mat-option>
                  @for (tutor of tutores; track tutor.id) {
                    <mat-option
                      [value]="tutor.id"
                      [disabled]="isTutorSeleccionado(tutor.id, 'tutor2Id')">
                      {{ tutor.nombre }}
                    </mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Rol Tutor 2</mat-label>
                <mat-select formControlName="tutor2Rol" [disabled]="!formularioPractica.get('tutor2Id')?.value">
                  <mat-option [value]="''">Sin rol asignado</mat-option>
                  @for (rol of rolesTutor; track rol) {
                    <mat-option [value]="rol">{{ rol }}</mat-option>
                  }
                </mat-select>
                @if (formularioPractica.get('tutor2Rol')?.hasError('required')) {
                  <mat-error>Indica el rol para el tutor seleccionado</mat-error>
                }
              </mat-form-field>
            </div>

            <!-- Fechas y Estado -->
            <div class="FormRow">
              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Fecha de Inicio *</mat-label>
                <input matInput [matDatepicker]="pickerInicio" formControlName="fecha_inicio">
                <mat-datepicker-toggle matIconSuffix [for]="pickerInicio"></mat-datepicker-toggle>
                <mat-datepicker #pickerInicio></mat-datepicker>
                @if (formularioPractica.get('fecha_inicio')?.hasError('required')) {
                  <mat-error>
                    Debe seleccionar una fecha de inicio
                  </mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Fecha de Término</mat-label>
                <input matInput [matDatepicker]="pickerTermino" formControlName="fecha_termino" [min]="fechaMinimaTermino">
                <mat-datepicker-toggle matIconSuffix [for]="pickerTermino"></mat-datepicker-toggle>
                <mat-datepicker #pickerTermino></mat-datepicker>
                @if (formularioPractica.get('fecha_termino')?.hasError('fechaAnterior')) {
                  <mat-error>
                    La fecha de término no puede ser anterior a la fecha de inicio
                  </mat-error>
                }
              </mat-form-field>
            </div>

            <!-- Tipo y Estado -->
            <div class="FormRow">
              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Tipo de Práctica</mat-label>
                <mat-select formControlName="tipo">
                  <mat-option [value]="null">Sin especificar</mat-option>
                  @for (tipo of tiposPractica; track tipo) {
                    <mat-option [value]="tipo">{{ tipo }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Estado</mat-label>
                <mat-select formControlName="estado">
                  @for (estado of estadosPractica; track estado) {
                    <mat-option [value]="estado">
                      {{ formatearEstado(estado) }}
                    </mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>

          </form>

          <div class="FormActions">
            <button mat-stroked-button (click)="cerrarFormulario()" class="CancelBtn">
              Cancelar
            </button>
            <button mat-raised-button color="primary" (click)="guardarPractica()" class="SubmitBtn">
              <mat-icon>person_add</mat-icon>
              Asignar Práctica
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    }
  </div>

  <!-- LISTADO DE ASIGNACIONES -->
  <div class="AssignmentsList" *ngIf="totalItems > 0">
    @for (assignment of asignacionesPaginadas; track assignment.id) {
      <mat-card class="AssignmentCard Elev">
        <mat-card-content>
          <div class="AssignmentContent">
            <!-- Información del estudiante -->
            <div class="StudentInfo">
              <div class="StudentHeader">
                <h3>{{ assignment.estudiante.nombre }}</h3>
                <div class="StudentDetails">
                  <span class="Rut">RUT: {{ assignment.estudiante.rut }}</span>
                </div>
              </div>
            </div>

            <!-- Información del centro educativo -->
            <div class="SchoolInfo">
              <div class="SchoolHeader">
                <mat-icon class="SchoolIcon">school</mat-icon>
                <div class="SchoolDetails">
                  <h4>{{ assignment.centro.nombre }}</h4>
                  <div class="SupervisorInfo">
                    <mat-icon class="LockIcon">supervisor_account</mat-icon>
                    <span>
                      Colaboradores: {{ formatColaboradores(assignment.colaboradores) }}
                    </span>
                  </div>
                  <div class="SupervisorInfo">
                    <mat-icon class="LockIcon">badge</mat-icon>
                    <span>
                      Tutores: {{ formatTutores(assignment.tutores) }}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Información de la práctica -->
            <div class="PracticeInfo">
              <div class="PracticeDetails">
                <div class="PracticeType">
                  <mat-icon class="TypeIcon">work</mat-icon>
                  <span>{{ assignment.tipo || 'Sin especificar' }}</span>
                </div>
                <div class="DateInfo">
                  <mat-icon class="DateIcon">event</mat-icon>
                  <span>{{ assignment.fechaInicio }} 
                    @if (assignment.fechaTermino) {
                      - {{ assignment.fechaTermino }}
                    } @else {
                      - Sin fecha de término
                    }
                  </span>
                </div>
              </div>
            </div>

            <!-- Estado -->
            <div class="StatusSection">
              <span class="StatusBadge" [ngClass]="assignment.estado.toLowerCase()">
                {{ formatearEstado(assignment.estado) }}
              </span>
            </div>

            <!-- Acción -->
            <div class="ActionSection">
              <button mat-stroked-button (click)="verDetalles(assignment)" class="DetailsBtn">
                Ver Detalles
              </button>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    }
  </div>

  <!-- PAGINADOR -->
  <div class="list-paginator" *ngIf="totalItems > 0">
    <mat-paginator
      [length]="totalItems"
      [pageIndex]="pageIndex"
      [pageSize]="pageSize"
      [pageSizeOptions]="pageSizeOptions"
      (page)="onPageChange($event)">
    </mat-paginator>
  </div>

  <!-- MENSAJE VACÍO -->
  @if (totalItems === 0) {
    <mat-card class="EmptyCard Elev">
      <mat-card-content class="EmptyContent">
        <mat-icon>assignment_turned_in</mat-icon>
        <h3>No se encontraron asignaciones</h3>
        <p>No hay asignaciones que coincidan con los filtros seleccionados.</p>
      </mat-card-content>
    </mat-card>
  }

  <!-- MODAL DE DETALLES -->
  @if (mostrarModalDetalles && practicaSeleccionada) {
    <div class="DetailsDialog">
      <div class="DialogOverlay" (click)="cerrarDetalles()"></div>
      <div class="DialogContent">
        <div class="DialogHeader">
          <h2>Detalles de la Práctica</h2>
          <button mat-icon-button (click)="cerrarDetalles()" class="CloseBtn">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        
        <div class="DialogBody">
          <div class="DetailsSections">
            
            <!-- Información General -->
            <div class="DetailSection">
              <h3 class="SectionTitle">
                <mat-icon>info</mat-icon>
                Información General
              </h3>
              <div class="DetailsGrid">
                <div class="DetailItem">
                  <label>Estado:</label>
                  <span class="StatusBadge" [ngClass]="practicaSeleccionada.estado.toLowerCase()">
                    {{ formatearEstado(practicaSeleccionada.estado) }}
                  </span>
                </div>
                <div class="DetailItem">
                  <label>Tipo:</label>
                  <span>{{ practicaSeleccionada.tipo || 'Sin especificar' }}</span>
                </div>
                <div class="DetailItem">
                  <label>Fecha de Inicio:</label>
                  <span>{{ practicaSeleccionada.fechaInicio }}</span>
                </div>
                <div class="DetailItem">
                  <label>Fecha de Término:</label>
                  <span>{{ practicaSeleccionada.fechaTermino || 'Sin fecha de término' }}</span>
                </div>
              </div>
            </div>

            <!-- Información del Estudiante -->
            <div class="DetailSection">
              <h3 class="SectionTitle">
                <mat-icon>person</mat-icon>
                Información del Estudiante
              </h3>
              <div class="DetailsGrid">
                <div class="DetailItem">
                  <label>Nombre:</label>
                  <span>{{ practicaSeleccionada.estudiante.nombre }}</span>
                </div>
                <div class="DetailItem">
                  <label>RUT:</label>
                  <span>{{ practicaSeleccionada.estudiante.rut }}</span>
                </div>
              </div>
            </div>

            <!-- Información del Centro Educativo -->
            <div class="DetailSection">
              <h3 class="SectionTitle">
                <mat-icon>school</mat-icon>
                Centro Educativo
              </h3>
              <div class="DetailsGrid">
                <div class="DetailItem">
                  <label>Nombre:</label>
                  <span>{{ practicaSeleccionada.centro.nombre }}</span>
                </div>
                <div class="DetailItem">
                  <label>Tipo:</label>
                  <span>{{ practicaSeleccionada.centro.tipo || 'Sin especificar' }}</span>
                </div>
                <div class="DetailItem">
                  <label>Dirección:</label>
                  <span>{{ practicaSeleccionada.centro.direccion || 'Sin especificar' }}</span>
                </div>
              </div>
            </div>

            <!-- Colaboradores asignados -->
            <div class="DetailSection">
              <h3 class="SectionTitle">
                <mat-icon>groups</mat-icon>
                Colaboradores
              </h3>
              @if (practicaSeleccionada.colaboradores && practicaSeleccionada.colaboradores.length) {
                <div class="CollaboratorsList">
                  @for (colaborador of practicaSeleccionada.colaboradores; track colaborador.id) {
                    <div class="CollaboratorRow">
                      <div class="CollaboratorInfo">
                        <span class="CollaboratorName">{{ colaborador.nombre }}</span>
                        @if (colaborador.cargo) {
                          <span class="CollaboratorCargo">• {{ colaborador.cargo }}</span>
                        }
                        @if (colaborador.correo) {
                          <span class="CollaboratorEmail">• {{ colaborador.correo }}</span>
                        }
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <p class="Muted">Sin colaboradores registrados para esta práctica.</p>
              }
            </div>

            <!-- Tutores asignados -->
            <div class="DetailSection">
              <h3 class="SectionTitle">
                <mat-icon>badge</mat-icon>
                Tutores
              </h3>
              @if (practicaSeleccionada.tutores && practicaSeleccionada.tutores.length) {
                <div class="TutorsList">
                  @for (tutor of practicaSeleccionada.tutores; track tutor.tutor.id) {
                    <div class="TutorRow">
                      <div class="TutorInfo">
                        <span class="TutorName">{{ tutor.tutor.nombre }}</span>
                        <span class="TutorRole">• {{ tutor.rol }}</span>
                        @if (tutor.tutor.correo) {
                          <span class="TutorEmail">• {{ tutor.tutor.correo }}</span>
                        }
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <p class="Muted">Sin tutores asignados para esta práctica.</p>
              }
            </div>

            <!-- Actividades -->
            @if (practicaSeleccionada.actividades && practicaSeleccionada.actividades.length > 0) {
              <div class="DetailSection">
                <h3 class="SectionTitle">
                  <mat-icon>assignment</mat-icon>
                  Actividades ({{ practicaSeleccionada.actividades.length }})
                </h3>
                <div class="ActivitiesList">
                  @for (actividad of practicaSeleccionada.actividades; track actividad.id) {
                    <div class="ActivityItem">
                      <div class="ActivityHeader">
                        <h4>{{ actividad.titulo }}</h4>
                        <span class="ActivityStatus" [ngClass]="actividad.completada ? 'completed' : 'pending'">
                          <mat-icon>{{ actividad.completada ? 'check_circle' : 'schedule' }}</mat-icon>
                          {{ actividad.completada ? 'Completada' : 'Pendiente' }}
                        </span>
                      </div>
                      @if (actividad.descripcion) {
                        <p class="ActivityDescription">{{ actividad.descripcion }}</p>
                      }
                      <div class="ActivityDate">
                        <mat-icon>event</mat-icon>
                        <span>{{ actividad.fecha }}</span>
                      </div>
                    </div>
                  }
                </div>
              </div>
            }

            <!-- Observaciones -->
            <div class="DetailSection">
              <div class="SectionHeader">
                <h3 class="SectionTitle">
                  <mat-icon>note</mat-icon>
                  Observaciones
                </h3>
                @if (esCoordinadoraPracticas) {
                  <button mat-icon-button (click)="abrirFormularioObservacion()" class="AddBtn" title="Agregar observación">
                    <mat-icon>add</mat-icon>
                  </button>
                }
              </div>
              
              @if (observaciones && observaciones.length > 0) {
                <div class="ObservationsList">
                  @for (obs of observaciones; track obs.id) {
                    <div class="ObservationItem">
                      <div class="ObservationContent">
                        <p class="ObservationText">{{ obs.descripcion }}</p>
                        <span class="ObservationDate">{{ formatearFecha(obs.fecha) }}</span>
                      </div>
                      @if (esCoordinadoraPracticas) {
                        <div class="ObservationActions">
                          <button mat-icon-button (click)="abrirFormularioObservacion(obs)" title="Editar observación">
                            <mat-icon>edit</mat-icon>
                          </button>
                          <button mat-icon-button (click)="eliminarObservacion(obs)" title="Eliminar observación" color="warn">
                            <mat-icon>delete</mat-icon>
                          </button>
                        </div>
                      }
                    </div>
                  }
                </div>
              } @else {
                <p class="NoActivities">No hay observaciones registradas para esta práctica.</p>
              }
            </div>

            <!-- Formulario de observación -->
            @if (mostrarFormularioObservacion && esCoordinadoraPracticas) {
              <div class="DetailSection ObservationForm">
                <h3 class="SectionTitle">
                  <mat-icon>{{ observacionEditando ? 'edit' : 'add' }}</mat-icon>
                  {{ observacionEditando ? 'Editar Observación' : 'Nueva Observación' }}
                </h3>
                <form [formGroup]="formularioObservacion" (ngSubmit)="guardarObservacion()">
                  <mat-form-field appearance="outline" class="FullWidth">
                    <mat-label>Descripción</mat-label>
                    <textarea matInput formControlName="descripcion" rows="4" placeholder="Ingrese la observación..."></textarea>
                    @if (formularioObservacion.get('descripcion')?.hasError('required') && formularioObservacion.get('descripcion')?.touched) {
                      <mat-error>La descripción es requerida</mat-error>
                    }
                    @if (formularioObservacion.get('descripcion')?.hasError('minlength') && formularioObservacion.get('descripcion')?.touched) {
                      <mat-error>La descripción debe tener al menos 3 caracteres</mat-error>
                    }
                  </mat-form-field>
                  <div class="FormActions">
                    <button mat-stroked-button type="button" (click)="cerrarFormularioObservacion()">Cancelar</button>
                    <button mat-raised-button color="primary" type="submit" [disabled]="formularioObservacion.invalid">
                      {{ observacionEditando ? 'Actualizar' : 'Crear' }}
                    </button>
                  </div>
                </form>
              </div>
            }

          </div>
        </div>
        
        <div class="DialogActions">
          <button mat-stroked-button (click)="cerrarDetalles()">Cerrar</button>
        </div>
      </div>
    </div>
  }
</div>
