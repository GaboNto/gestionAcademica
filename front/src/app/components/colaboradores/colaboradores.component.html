<div class="container section">
  <!-- HEADER -->
  <div class="header">
    
    <div class="headline">
      <h1>Gestión de Colaboradores</h1>
    </div>

    <div class="spacer"></div>

    <!-- BOTÓN AGREGAR -->
    <button mat-flat-button color="primary" (click)="toggleForm()" class="btn-add">
      <mat-icon>{{ showForm ? 'close' : 'person_add' }}</mat-icon>
      {{ showForm ? 'Cerrar' : 'Agregar colaborador' }}
    </button>
  </div>

  <!-- FILTROS INTEGRADOS -->
  <div class="filters-section">
    <div class="filters">
      <mat-form-field appearance="outline" class="flex1">
        <mat-label>Buscar por nombre, email o cargo…</mat-label>
        <input matInput [(ngModel)]="searchTerm" />
      </mat-form-field>

      <mat-form-field appearance="outline" class="role-filter">
        <mat-label>Rol</mat-label>
        <mat-select [(ngModel)]="selectedRole">
          <mat-option value="all">Todos</mat-option>
          <mat-option value="Supervisor">Supervisor</mat-option>
          <mat-option value="Colaborador">Colaborador</mat-option>
          <mat-option value="Tallerista">Tallerista</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </div>

  <!-- FORMULARIO (colapsable por botón) -->
  <div class="form-container" [class.form-open]="showForm">
    @if (showForm) {
      <mat-card class="elev form-card">
        <mat-card-header class="form-header">
          <div class="form-title-section">
            <div class="form-icon">
              <mat-icon>{{ isEditing ? 'edit' : 'person_add' }}</mat-icon>
            </div>
          <div class="form-titles">
            <h2>{{ isEditing ? 'Editar colaborador' : 'Agregar colaborador' }}</h2>
            <p>{{ isEditing ? 'Modifica los datos del colaborador' : 'Completa los datos para registrar un nuevo colaborador' }}</p>
          </div>
          </div>
          <button mat-icon-button (click)="toggleForm()" class="close-form-btn">
            <mat-icon>close</mat-icon>
          </button>
        </mat-card-header>

        <mat-card-content class="form-content">
          <form class="form-grid">
            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Nombre completo</mat-label>
                <input matInput [(ngModel)]="newColaborador.nombre" name="nombre" required />
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>RUT</mat-label>
                <input matInput [(ngModel)]="newColaborador.rut" name="rut" placeholder="12.345.678-9" />
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Email</mat-label>
                <input matInput [(ngModel)]="newColaborador.email" name="email" type="email" required />
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Teléfono</mat-label>
                <input matInput [(ngModel)]="newColaborador.telefono" name="telefono" placeholder="+56 9 ..." />
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field full-width">
                <mat-label>Dirección</mat-label>
                <input matInput [(ngModel)]="newColaborador.direccion" name="direccion" placeholder="Calle 123, Comuna, Región" />
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Rol</mat-label>
                <mat-select [(ngModel)]="newColaborador.role" name="role" required>
                  <mat-option value="Supervisor">Supervisor</mat-option>
                  <mat-option value="Colaborador">Colaborador</mat-option>
                  <mat-option value="Tallerista">Tallerista</mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Cargo</mat-label>
                <input matInput [(ngModel)]="newColaborador.especialidad" name="especialidad" placeholder="Profesor de Historia, Coordinador…" />
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field full-width">
                <mat-label>Universidad de egreso</mat-label>
                <input matInput [(ngModel)]="newColaborador.experiencia" name="experiencia" placeholder="Universidad de Chile, PUC…" />
              </mat-form-field>
            </div>
          </form>

        <div class="form-actions">
          <button mat-stroked-button (click)="toggleForm()" class="cancel-btn">
            Cancelar
          </button>
          <button mat-raised-button color="primary" (click)="isEditing ? updateColaborador() : addColaborador()" class="submit-btn">
            <mat-icon>{{ isEditing ? 'save' : 'person_add' }}</mat-icon> 
            {{ isEditing ? 'Guardar cambios' : 'Añadir' }}
          </button>
        </div>
        </mat-card-content>
      </mat-card>
    }
  </div>

  <!-- LISTADO DE COLABORADORES -->
  <mat-card class="elev">
    <mat-card-content class="list-container">
      @for (c of filtered(); track c.email) {
        <div class="list-item">
          <div class="item-content">
            <!-- Avatar y nombre -->
            <div class="item-main">
              <div
                class="avatar-small"
                [ngClass]="c.role === 'Supervisor' ? 'blue' : c.role === 'Tallerista' ? 'teal' : 'purple'">
                <mat-icon>
                  {{ c.role === 'Supervisor' ? 'supervisor_account' : c.role === 'Tallerista' ? 'handyman' : 'person' }}
                </mat-icon>
              </div>
              <div class="item-info">
                <h3>{{ c.nombre }}</h3>
                <p class="muted">{{ c.email }}</p>
              </div>
            </div>

            <!-- Rol y cargo -->
            <div class="item-role">
              <strong>{{ c.role }}</strong>
              @if (c.especialidad) {
                <span> · {{ c.especialidad }}</span>
              }
            </div>

            <!-- Acciones -->
            <div class="item-actions">
              <button mat-icon-button color="accent" (click)="viewDetails(c)" title="Ver más información">
                <mat-icon>visibility</mat-icon>
              </button>
            <button mat-icon-button color="primary" (click)="editColaborador(c)" title="Editar">
              <mat-icon>edit</mat-icon>
            </button>
              <button mat-icon-button color="warn" (click)="remove(c)" title="Eliminar">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </div>
      }
    </mat-card-content>
  </mat-card>

  <!-- EMPTY -->
  @if (!filtered().length) {
    <mat-card class="elev empty">
      <mat-card-content class="muted empty__content">
        <mat-icon>group_off</mat-icon>
        <p>No se encontraron colaboradores con los filtros seleccionados.</p>
      </mat-card-content>
    </mat-card>
  }

  <!-- DIALOGO DETALLES -->
  @if (selectedColaborador) {
    <div class="details-dialog">
      <div class="dialog-overlay" (click)="closeDetails()"></div>
      <div class="dialog-content">
        <div class="dialog-header">
          <h2>Información del Colaborador</h2>
          <button mat-icon-button (click)="closeDetails()" class="close-btn">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        
        <div class="dialog-body">
          <div class="details-grid">
            <div class="detail-item">
              <label>Nombre completo:</label>
              <span>{{ selectedColaborador.nombre }}</span>
            </div>
            
            <div class="detail-item">
              <label>RUT:</label>
              <span>{{ selectedColaborador.rut || 'No especificado' }}</span>
            </div>
            
            <div class="detail-item">
              <label>Email:</label>
              <span>{{ selectedColaborador.email }}</span>
            </div>
            
            <div class="detail-item">
              <label>Dirección:</label>
              <span>{{ selectedColaborador.direccion || 'No especificada' }}</span>
            </div>
            
            <div class="detail-item">
              <label>Teléfono:</label>
              <span>{{ selectedColaborador.telefono || 'No especificado' }}</span>
            </div>
            
            <div class="detail-item">
              <label>Rol:</label>
              <span>{{ selectedColaborador.role }}</span>
            </div>
            
            <div class="detail-item">
              <label>Cargo:</label>
              <span>{{ selectedColaborador.especialidad || 'No especificado' }}</span>
            </div>
            
            <div class="detail-item">
              <label>Universidad de egreso:</label>
              <span>{{ selectedColaborador.experiencia || 'No especificada' }}</span>
            </div>
          </div>
        </div>
        
        <div class="dialog-actions">
          <button mat-stroked-button (click)="closeDetails()">Cerrar</button>
        <button mat-raised-button color="primary" (click)="editColaborador(selectedColaborador!)">
          <mat-icon>edit</mat-icon>
          Editar colaborador
        </button>
        </div>
      </div>
    </div>
  }

  <!-- MODAL DE CONFIRMACIÓN DE ELIMINACIÓN -->
  @if (showDeleteConfirm && colaboradorToDelete) {
    <div class="delete-confirm-dialog">
      <div class="dialog-overlay" (click)="closeDeleteConfirm()"></div>
      <div class="delete-dialog-content">
        <div class="delete-dialog-header">
          <div class="delete-icon">
            <mat-icon>warning</mat-icon>
          </div>
          <h2>Confirmar eliminación</h2>
        </div>
        
        <div class="delete-dialog-body">
          <p>¿Estás seguro de que quieres eliminar a <strong>{{ colaboradorToDelete.nombre }}</strong>?</p>
          <p class="warning-text">Esta acción no se puede deshacer.</p>
        </div>
        
        <div class="delete-dialog-actions">
          <button mat-stroked-button (click)="closeDeleteConfirm()" class="cancel-delete-btn">
            Cancelar
          </button>
          <button mat-raised-button color="warn" (click)="confirmDelete()" class="confirm-delete-btn">
            <mat-icon>delete</mat-icon>
            Eliminar
          </button>
        </div>
      </div>
    </div>
  }
</div>
