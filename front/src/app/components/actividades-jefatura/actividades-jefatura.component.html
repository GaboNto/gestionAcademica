<div class="page">
  <header class="page__header">
    <div>
      <p class="eyebrow">Jefatura de carrera</p>
      <h1>Listado de actividades</h1>
      <p class="muted">Supervisa actividades, estados y fechas de entrega.</p>
    </div>
    <div class="header__meta">
      <span class="badge">Solo lectura</span>
    </div>
  </header>

  <section class="filters">
    <mat-form-field appearance="outline">
      <mat-label>Buscar por nombre o palabra clave</mat-label>
      <input matInput [(ngModel)]="filtros.search" (ngModelChange)="onSearchChange()" placeholder="Ej: informe, taller..." />
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Tipo</mat-label>
      <mat-select [(ngModel)]="filtros.tipo" (selectionChange)="onFiltroChange()">
        <mat-option value="">Todos</mat-option>
        <mat-option *ngFor="let t of tipos" [value]="t">{{ t }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Estado</mat-label>
      <mat-select [(ngModel)]="filtros.estado" (selectionChange)="onFiltroChange()">
        <mat-option value="">Todos</mat-option>
        <mat-option *ngFor="let e of estados" [value]="e.value">{{ e.label }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Fecha inicio</mat-label>
      <input matInput type="date" [(ngModel)]="filtros.fechaInicio" (ngModelChange)="onFiltroChange()" />
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Fecha fin</mat-label>
      <input matInput type="date" [(ngModel)]="filtros.fechaFin" (ngModelChange)="onFiltroChange()" />
    </mat-form-field>

    <button mat-button color="primary" class="filters__reset" (click)="limpiarFiltros()">
      <mat-icon>refresh</mat-icon>
      Limpiar
    </button>
  </section>

  <section class="table-card">
    <div class="table-card__header">
      <div>
        <h2>Actividades registradas</h2>
        <p class="muted">Se muestran {{ total }} actividades.</p>
      </div>
      <div class="sorters">
        <button mat-stroked-button (click)="toggleSort('fechaInicio')">
          <mat-icon>calendar_today</mat-icon>
          Fecha inicio
        </button>
        <button mat-stroked-button (click)="toggleSort('estado')">
          <mat-icon>flag</mat-icon>
          Estado
        </button>
      </div>
    </div>

    <div class="table-wrapper" *ngIf="!cargando; else loadingTpl">
      <table mat-table [dataSource]="actividades" class="mat-elevation-z1">
        <ng-container matColumnDef="nombre">
          <th mat-header-cell *matHeaderCellDef>Nombre</th>
          <td mat-cell *matCellDef="let actividad">
            <div class="cell-title">{{ actividad.nombre }}</div>
            <div class="cell-subtitle" *ngIf="actividad.descripcion">{{ actividad.descripcion }}</div>
          </td>
        </ng-container>

        <ng-container matColumnDef="tipo">
          <th mat-header-cell *matHeaderCellDef>Tipo</th>
          <td mat-cell *matCellDef="let actividad">{{ actividad.tipo }}</td>
        </ng-container>

        <ng-container matColumnDef="fechas">
          <th mat-header-cell *matHeaderCellDef>Fecha inicio / término</th>
          <td mat-cell *matCellDef="let actividad">
            <div>{{ formatearFecha(actividad.fechaInicio) }}</div>
            <div class="cell-subtitle">{{ formatearFecha(actividad.fechaFin) }}</div>
          </td>
        </ng-container>

        <ng-container matColumnDef="estado">
          <th mat-header-cell *matHeaderCellDef>Estado</th>
          <td mat-cell *matCellDef="let actividad">
            <span [ngClass]="estadoClase(actividad.estado)">{{ actividad.estado }}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="responsable">
          <th mat-header-cell *matHeaderCellDef>Responsable</th>
          <td mat-cell *matCellDef="let actividad">{{ actividad.responsable }}</td>
        </ng-container>

        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let actividad">
            <button mat-stroked-button color="primary" (click)="verDetalle(actividad)">
              <mat-icon>visibility</mat-icon>
              Detalle
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>

      <div class="empty" *ngIf="!actividades.length">
        <mat-icon>inbox</mat-icon>
        <p>No hay actividades disponibles.</p>
      </div>
    </div>

    <ng-template #loadingTpl>
      <div class="loading">
        <mat-progress-spinner diameter="36" mode="indeterminate"></mat-progress-spinner>
        <span>Cargando actividades...</span>
      </div>
    </ng-template>

    <mat-paginator
      [length]="total"
      [pageSize]="pageSize"
      [pageIndex]="pageIndex"
      [pageSizeOptions]="pageSizeOptions"
      (page)="onPageChange($event)">
    </mat-paginator>
  </section>

  <section class="detail" *ngIf="seleccionada">
    <header>
      <div>
        <p class="eyebrow">Detalle de actividad</p>
        <h3>{{ seleccionada?.nombre }}</h3>
        <p class="muted">{{ seleccionada?.descripcion || 'Sin descripción' }}</p>
      </div>
      <span [ngClass]="estadoClase(seleccionada.estado)">{{ seleccionada.estado }}</span>
    </header>
    <div class="detail__grid">
      <div>
        <label>Tipo</label>
        <p>{{ seleccionada.tipo }}</p>
      </div>
      <div>
        <label>Responsable</label>
        <p>{{ seleccionada.responsable }}</p>
      </div>
      <div>
        <label>Fecha inicio</label>
        <p>{{ formatearFecha(seleccionada.fechaInicio) }}</p>
      </div>
      <div>
        <label>Fecha término</label>
        <p>{{ formatearFecha(seleccionada.fechaFin) }}</p>
      </div>
    </div>
  </section>
</div>
